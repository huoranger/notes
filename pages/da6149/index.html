<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud | 清风徐来</title>
    <meta name="generator" content="VuePress 1.9.5">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="后端学习记录">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,后端面试题,技术文档,学习,面试,Spring,SpringBoot,SpringCloud,中间件,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.379d0a3f.css" as="style"><link rel="preload" href="/assets/js/app.342c2b09.js" as="script"><link rel="preload" href="/assets/js/2.30520199.js" as="script"><link rel="preload" href="/assets/js/3.b6a398a6.js" as="script"><link rel="preload" href="/assets/js/21.aebf0481.js" as="script"><link rel="prefetch" href="/assets/js/10.994b5850.js"><link rel="prefetch" href="/assets/js/11.c1659061.js"><link rel="prefetch" href="/assets/js/12.959fe22d.js"><link rel="prefetch" href="/assets/js/13.24a0262d.js"><link rel="prefetch" href="/assets/js/14.bf436452.js"><link rel="prefetch" href="/assets/js/15.2c8697f1.js"><link rel="prefetch" href="/assets/js/16.f7279506.js"><link rel="prefetch" href="/assets/js/17.84715369.js"><link rel="prefetch" href="/assets/js/18.dfb7bd60.js"><link rel="prefetch" href="/assets/js/19.aa4102e6.js"><link rel="prefetch" href="/assets/js/20.3ff19899.js"><link rel="prefetch" href="/assets/js/22.d02107b3.js"><link rel="prefetch" href="/assets/js/23.d0073c19.js"><link rel="prefetch" href="/assets/js/24.ca62c6c8.js"><link rel="prefetch" href="/assets/js/25.3a7af7e4.js"><link rel="prefetch" href="/assets/js/26.cf842bf6.js"><link rel="prefetch" href="/assets/js/27.d6b311ac.js"><link rel="prefetch" href="/assets/js/28.e2825727.js"><link rel="prefetch" href="/assets/js/29.81125c48.js"><link rel="prefetch" href="/assets/js/30.02d12be4.js"><link rel="prefetch" href="/assets/js/31.d5e768cf.js"><link rel="prefetch" href="/assets/js/32.61fe1e37.js"><link rel="prefetch" href="/assets/js/33.41697b98.js"><link rel="prefetch" href="/assets/js/34.422b5161.js"><link rel="prefetch" href="/assets/js/35.1712aa86.js"><link rel="prefetch" href="/assets/js/36.7e13554a.js"><link rel="prefetch" href="/assets/js/4.c3c02f28.js"><link rel="prefetch" href="/assets/js/5.cb2907b0.js"><link rel="prefetch" href="/assets/js/6.ef14ec81.js"><link rel="prefetch" href="/assets/js/7.f44b1772.js"><link rel="prefetch" href="/assets/js/8.bd9a75af.js"><link rel="prefetch" href="/assets/js/9.9c7d3342.js">
    <link rel="stylesheet" href="/assets/css/0.styles.379d0a3f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="清风徐来" class="logo"> <span class="site-name can-hide">清风徐来</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程人生" class="dropdown-title"><a href="/web/" class="link-title">编程人生</a> <span class="title" style="display:none;">编程人生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习记录</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/967878/" class="nav-link">后端笔记</a></li><li class="dropdown-subitem"><a href="/pages/10650d/" class="nav-link">前端笔记</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/21e73a/" class="nav-link">面试突击</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://acheng.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  心情杂货
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/pages/6da187/" class="nav-link">我的简历</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/huoranger" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://avatars.githubusercontent.com/u/67517385?v=4"> <div class="blogger-info"><h3>清风徐来</h3> <span>分享欲望需要靠回应来延续，热情也是。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程人生" class="dropdown-title"><a href="/web/" class="link-title">编程人生</a> <span class="title" style="display:none;">编程人生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习记录</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/967878/" class="nav-link">后端笔记</a></li><li class="dropdown-subitem"><a href="/pages/10650d/" class="nav-link">前端笔记</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/21e73a/" class="nav-link">面试突击</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://acheng.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  心情杂货
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/pages/6da187/" class="nav-link">我的简历</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/huoranger" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/fe7d50/" class="sidebar-link">Java虚拟机</a></li><li><a href="/pages/a327fa/" class="sidebar-link">并发编程</a></li><li><a href="/pages/52faf7/" class="sidebar-link">MyBatis</a></li><li><a href="/pages/eab6da/" class="sidebar-link">SpringBoot</a></li><li><a href="/pages/28a0e7/" class="sidebar-link">SpringSecurity</a></li><li><a href="/pages/da6149/" aria-current="page" class="active sidebar-link">SpringCloud</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/da6149/#认识微服务" class="sidebar-link">认识微服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#单体架构" class="sidebar-link">单体架构</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#分布式架构" class="sidebar-link">分布式架构</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#微服务" class="sidebar-link">微服务</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#springcloud" class="sidebar-link">SpringCloud</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#技术栈对比" class="sidebar-link">技术栈对比</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/da6149/#eureka注册中心" class="sidebar-link">Eureka注册中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#搭建注册中心" class="sidebar-link">搭建注册中心</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#搭建-eureka-server" class="sidebar-link">搭建 eureka-server</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#编写启动类" class="sidebar-link">编写启动类</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#编写配置文件" class="sidebar-link">编写配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#服务注册" class="sidebar-link">服务注册</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#服务拉取" class="sidebar-link">服务拉取</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/da6149/#ribbon负载均衡" class="sidebar-link">Ribbon负载均衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#源码跟踪" class="sidebar-link">源码跟踪</a></li><li class="sidebar-sub-header level3"><a href="/pages/da6149/#流程总结" class="sidebar-link">流程总结</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#负载均衡策略" class="sidebar-link">负载均衡策略</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#自定义策略" class="sidebar-link">自定义策略</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#饥饿加载" class="sidebar-link">饥饿加载</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/da6149/#nacos注册中心" class="sidebar-link">Nacos注册中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#服务注册-2" class="sidebar-link">服务注册</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#引入依赖" class="sidebar-link">引入依赖</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#配置nacos地址" class="sidebar-link">配置nacos地址</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/da6149/#feign远程调用" class="sidebar-link">Feign远程调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#feign使用" class="sidebar-link">Feign使用</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#引入依赖-2" class="sidebar-link">引入依赖</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#添加注解" class="sidebar-link">添加注解</a></li><li class="sidebar-sub-header level4"><a href="/pages/da6149/#请求接口" class="sidebar-link">请求接口</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/da6149/#gateway网关" class="sidebar-link">Gateway网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/da6149/#入门使用" class="sidebar-link">入门使用</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他分类</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page han-la"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF" title="分类" data-v-06970110>后端技术</a></li><li data-v-06970110><a href="/categories/?category=%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF" title="分类" data-v-06970110>后端技术</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/huoranger" target="_blank" title="作者" class="beLink" data-v-06970110>huoranger</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2022-11-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">SpringCloud<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="认识微服务"><a href="#认识微服务" class="header-anchor">#</a> 认识微服务</h2> <h3 id="单体架构"><a href="#单体架构" class="header-anchor">#</a> 单体架构</h3> <p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901083809.png!/format/webp" alt="img"></p> <p><strong>优点</strong>：架构简单，部署成本低</p> <p><strong>缺点</strong>：耦合度高（维护困难、升级困难）</p> <h3 id="分布式架构"><a href="#分布式架构" class="header-anchor">#</a> 分布式架构</h3> <p><strong>分布式架构</strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901092921.png!/format/webp" alt="img"></p> <p><strong>优点</strong>：降低服务耦合，有利于服务升级和拓展</p> <p><strong>缺点</strong>：服务调用关系错综复杂</p> <p>分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：</p> <ul><li>服务拆分的粒度如何界定？</li> <li>服务之间如何调用？</li> <li>服务的调用关系如何管理？</li></ul> <h3 id="微服务"><a href="#微服务" class="header-anchor">#</a> 微服务</h3> <p>微服务的架构特征：</p> <ul><li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责</li> <li>自治：团队独立、技术独立、数据独立，独立部署和交付</li> <li>面向服务：服务提供统一标准的接口，与语言和技术无关</li> <li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li></ul> <p><img src="https://cdn.xn2001.com/img/2022/202205162352847.png!/format/webp" alt="img"></p> <p>微服务的上述特性<strong>其实是在给分布式架构制定一个标准</strong>，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。</p> <p>因此，<strong>可以认为微服务是一种经过良好架构设计的分布式架构方案</strong> 。其中在 Java 领域最引人注目的就是 SpringCloud 提供的方案了。</p> <h3 id="springcloud"><a href="#springcloud" class="header-anchor">#</a> SpringCloud</h3> <p>SpringCloud 是目前国内使用最广泛的微服务框架。官网地址：<a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener noreferrer">https://spring.io/projects/spring-cloud<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>SpringCloud 集成了各种微服务功能组件，并基于 SpringBoot 实现了这些组件的自动装配，从而提供了良好的开箱即用体验。</p> <p>其中常见的组件包括：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901083717.png!/format/webp" alt="img"></p> <p>另外，SpringCloud 底层是依赖于 SpringBoot 的，并且有版本的兼容关系，如下：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901084050.png!/format/webp" alt="img"></p> <h3 id="技术栈对比"><a href="#技术栈对比" class="header-anchor">#</a> 技术栈对比</h3> <p><img src="https://cdn.xn2001.com/img/2021/20210901090726.png!/format/webp" alt="img"></p> <h2 id="eureka注册中心"><a href="#eureka注册中心" class="header-anchor">#</a> Eureka注册中心</h2> <p>最广为人知的注册中心就是 Eureka，其结构如下：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901090919.png!/format/webp" alt="img"></p> <h3 id="搭建注册中心"><a href="#搭建注册中心" class="header-anchor">#</a> 搭建注册中心</h3> <h4 id="搭建-eureka-server"><a href="#搭建-eureka-server" class="header-anchor">#</a> 搭建 eureka-server</h4> <p>引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 <strong>server</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="编写启动类"><a href="#编写启动类" class="header-anchor">#</a> 编写启动类</h4> <p>注意要添加一个 <code>@EnableEurekaServer</code> <strong>注解</strong>，开启 eureka 的<strong>注册中心</strong>功能</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="编写配置文件"><a href="#编写配置文件" class="header-anchor">#</a> 编写配置文件</h4> <p>编写一个 application.yml 文件，内容如下：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><p>其中 <code>default-zone</code> 是因为前面配置类开启了注册中心所需要配置的 eureka 的<strong>地址信息</strong>，因为 eureka 本身也是一个微服务，这里也要将自己注册进来，当后面 eureka <strong>集群</strong>时，这里就可以填写多个，使用 “,” 隔开。</p> <p>启动完成后，访问 <a href="http://localhost:10086/" target="_blank" rel="noopener noreferrer">http://localhost:10086/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="服务注册"><a href="#服务注册" class="header-anchor">#</a> 服务注册</h3> <p>引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 <strong>client</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在启动类上添加注解：<code>@EnableEurekaClient</code></p> <p>在 application.yml 文件，添加下面的配置：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token comment">#name：orderservice</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><h3 id="服务拉取"><a href="#服务拉取" class="header-anchor">#</a> 服务拉取</h3> <p>首先给 <code>RestTemplate</code> 这个 Bean 添加一个 <code>@LoadBalanced</code> <strong>注解</strong>，用于开启<strong>负载均衡</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>访问服务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://服务名/user/&quot;</span> <span class="token operator">+</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user <span class="token operator">=</span> restTemplage<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ribbon负载均衡"><a href="#ribbon负载均衡" class="header-anchor">#</a> Ribbon负载均衡</h2> <p>我们添加了 <code>@LoadBalanced</code> 注解，即可实现负载均衡功能，这是什么原理呢？</p> <p><strong>SpringCloud 底层提供了一个名为 Ribbon 的组件，来实现负载均衡功能。</strong></p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091242.png!/format/webp" alt="img"></p> <h3 id="源码跟踪"><a href="#源码跟踪" class="header-anchor">#</a> 源码跟踪</h3> <p>为什么我们只输入了 service 名称就可以访问了呢？为什么不需要获取 ip 和端口，这显然有人帮我们根据 service 名称，获取到了服务实例的ip和端口。它就是<code>LoadBalancerInterceptor</code>，这个类会在对 RestTemplate 的请求进行拦截，然后从 Eureka 根据服务 id 获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务 id。</p> <p>我们进行源码跟踪：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091323.png!/format/webp" alt="img"></p> <p>这里的 <code>intercept()</code> 方法，拦截了用户的 HttpRequest 请求，然后做了几件事：</p> <ul><li><code>request.getURI()</code>：获取请求uri，即 http://user-service/user/8</li> <li><code>originalUri.getHost()</code>：获取uri路径的主机名，其实就是服务id <code>user-service</code></li> <li><code>this.loadBalancer.execute()</code>：处理服务id，和用户请求</li></ul> <p>这里的 <code>this.loadBalancer</code> 是 <code>LoadBalancerClient</code> 类型继续跟入 <code>execute()</code> 方法：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091330.png!/format/webp" alt="img"></p> <ul><li><code>getLoadBalancer(serviceId)</code>：根据服务 id 获取 <code>ILoadBalancer</code>，而 <code>ILoadBalancer</code> 会拿着服务 id 去 eureka 中获取服务列表。</li> <li><code>getServer(loadBalancer)</code>：利用内置的负载均衡算法，从服务列表中选择一个。在图中<strong>可以看到获取了8082端口的服务</strong></li></ul> <p>可以看到获取服务时，通过一个 <code>getServer()</code> 方法来做负载均衡:</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091345.png!/format/webp" alt="img"></p> <p>我们继续跟入：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091355.png!/format/webp" alt="img"></p> <p>继续跟踪源码 <code>chooseServer()</code> 方法，发现这么一段代码：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091414.png!/format/webp" alt="img"></p> <p>我们看看这个 <code>rule</code> 是谁：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091432.png!/format/webp" alt="img"></p> <p>这里的 rule 默认值是一个 <code>RoundRobinRule</code> ，看类的介绍：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091442.png!/format/webp" alt="img"></p> <blockquote><p>负载均衡默认使用了轮训算法，当然我们也可以自定义。</p></blockquote> <h3 id="流程总结"><a href="#流程总结" class="header-anchor">#</a> 流程总结</h3> <p>SpringCloud Ribbon 底层采用了一个拦截器，拦截了 RestTemplate 发出的请求，对地址做了修改。</p> <p>基本流程如下：</p> <ul><li>拦截我们的 <code>RestTemplate</code> 请求 http://userservice/user/1</li> <li><code>RibbonLoadBalancerClient</code> 会从请求url中获取服务名称，也就是 user-service</li> <li><code>DynamicServerListLoadBalancer</code> 根据 user-service 到 eureka 拉取服务列表</li> <li>eureka 返回列表，localhost:8081、localhost:8082</li> <li><code>IRule</code> 利用内置负载均衡规则，从列表中选择一个，例如 localhost:8081</li> <li><code>RibbonLoadBalancerClient</code> 修改请求地址，用 localhost:8081 替代 userservice，得到 http://localhost:8081/user/1，发起真实请求</li></ul> <p><img src="https://cdn.xn2001.com/img/2021/20210901091755.png!/format/webp" alt="img"></p> <h4 id="负载均衡策略"><a href="#负载均衡策略" class="header-anchor">#</a> 负载均衡策略</h4> <p>负载均衡的规则都定义在 IRule 接口中，而 IRule 有很多不同的实现类：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091811.png!/format/webp" alt="img"></p> <p>不同规则的含义如下：</p> <table><thead><tr><th style="text-align:left;"><strong>内置负载均衡规则类</strong></th> <th style="text-align:left;"><strong>规则描述</strong></th></tr></thead> <tbody><tr><td style="text-align:left;">RoundRobinRule</td> <td style="text-align:left;">简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td></tr> <tr><td style="text-align:left;">AvailabilityFilteringRule</td> <td style="text-align:left;">对以下两种服务器进行忽略：（1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule 规则的客户端也会将其忽略。并发连接数的上限，可以由客户端设置。</td></tr> <tr><td style="text-align:left;">WeightedResponseTimeRule</td> <td style="text-align:left;">为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr> <tr><td style="text-align:left;"><strong>ZoneAvoidanceRule</strong></td> <td style="text-align:left;">以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。</td></tr> <tr><td style="text-align:left;">BestAvailableRule</td> <td style="text-align:left;">忽略那些短路的服务器，并选择并发数较低的服务器。</td></tr> <tr><td style="text-align:left;">RandomRule</td> <td style="text-align:left;">随机选择一个可用的服务器。</td></tr> <tr><td style="text-align:left;">RetryRule</td> <td style="text-align:left;">重试机制的选择逻辑</td></tr></tbody></table> <p>默认的实现就是 <code>ZoneAvoidanceRule</code>，<strong>是一种轮询方案</strong>。</p> <h4 id="自定义策略"><a href="#自定义策略" class="header-anchor">#</a> 自定义策略</h4> <p>通过定义 IRule 实现可以修改负载均衡规则，有两种方式：</p> <ol><li>代码方式在 order-service 中的 OrderApplication 类中，定义一个新的 IRule</li></ol> <p><img src="https://cdn.xn2001.com/img/2021/20210901091832.png!/format/webp" alt="img"></p> <ol start="2"><li>配置文件方式：在 order-service 的 application.yml 文件中，添加新的配置也可以修改规则：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># 给需要调用的微服务配置负载均衡规则，orderservice服务去调用userservice服务</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># 负载均衡规则 </span>
</code></pre></div><blockquote><p><strong>注意</strong>：一般用默认的负载均衡规则，不做修改。</p></blockquote> <h4 id="饥饿加载"><a href="#饥饿加载" class="header-anchor">#</a> 饥饿加载</h4> <p>当我们启动 orderservice，第一次访问时，时间消耗会大很多，这是因为 Ribbon 懒加载的机制。</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091850.png!/format/webp" alt="img"></p> <p>Ribbon 默认是采用懒加载，即第一次访问时才会去创建 LoadBalanceClient，拉取集群地址，所以请求时间会很长。</p> <p>而饥饿加载则会在项目启动时创建 LoadBalanceClient，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> userservice <span class="token comment"># 项目启动时直接去拉取userservice的集群，多个用&quot;,&quot;隔开</span>
</code></pre></div><h2 id="nacos注册中心"><a href="#nacos注册中心" class="header-anchor">#</a> Nacos注册中心</h2> <p>SpringCloudAlibaba 推出了一个名为 Nacos 的注册中心，在国外也有大量的使用。</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901091857.png!/format/webp" alt="img"></p> <p>解压启动 Nacos，详细请看 <a href="https://www.xn2001.com/archives/661.html" target="_blank" rel="noopener noreferrer">Nacos安装指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shel extra-class"><pre class="language-text"><code>startup.cmd -m standalone
</code></pre></div><p>访问：<a href="http://localhost:8848/nacos/" target="_blank" rel="noopener noreferrer">http://localhost:8848/nacos/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="服务注册-2"><a href="#服务注册-2" class="header-anchor">#</a> 服务注册</h3> <p>这里上来就直接服务注册，很多东西可能有疑惑，其实 Nacos 本身就是一个 SprintBoot 项目，这点你从启动的控制台打印就可以看出来，所以就不再需要去额外搭建一个像 Eureka 的注册中心。</p> <h4 id="引入依赖"><a href="#引入依赖" class="header-anchor">#</a> 引入依赖</h4> <p>在 cloud-demo 父工程中引入 SpringCloudAlibaba 的依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在 user-service 和 order-service 中的pom文件中引入 nacos-discovery 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="配置nacos地址"><a href="#配置nacos地址" class="header-anchor">#</a> 配置nacos地址</h4> <p>在 user-service 和 order-service 的 application.yml 中添加 nacos 地址：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre></div><p>// TODO</p> <h2 id="feign远程调用"><a href="#feign远程调用" class="header-anchor">#</a> Feign远程调用</h2> <p>我们以前利用 RestTemplate 发起远程调用的代码：</p> <p><img src="https://cdn.xn2001.com/img/2021/20210901092616.png!/format/webp" alt="img"></p> <ul><li>代码可读性差，编程体验不统一</li> <li>参数复杂URL难以维护</li></ul> <p>Feign 是一个声明式的 http 客户端，官方地址：<a href="https://github.com/OpenFeign/feign" target="_blank" rel="noopener noreferrer">https://github.com/OpenFeign/feign<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>其作用就是帮助我们<strong>优雅的实现 http 请求的发送</strong>，解决上面提到的问题。</p> <h3 id="feign使用"><a href="#feign使用" class="header-anchor">#</a> Feign使用</h3> <h4 id="引入依赖-2"><a href="#引入依赖-2" class="header-anchor">#</a> 引入依赖</h4> <p>我们在 order-service 引入 feign 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="添加注解"><a href="#添加注解" class="header-anchor">#</a> 添加注解</h4> <p>在 order-service 启动类添加 <code>@EnableFeignClient</code> 注解开启 Feign</p> <h4 id="请求接口"><a href="#请求接口" class="header-anchor">#</a> 请求接口</h4> <p>在 order-service 中新建一个接口，内容如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;userservice&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>@FeignClient(&quot;userservice&quot;)</code>：其中参数填写的是微服务名</p></li> <li><p><code>@GetMapping(&quot;/user/{id}&quot;)</code>：其中参数填写的是请求路径</p></li></ul> <p>这个客户端主要是基于 SpringMVC 的注解 <code>@GetMapping</code> 来声明远程调用的信息，Feign 可以帮助我们发送 http 请求，无需自己使用 RestTemplate 来发送了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserClient</span> userClient<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">queryOrderAndUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.查询订单</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: 2021/8/20 使用feign远程调用</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userClient<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 将用户信息封装进订单</span>
    order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.返回</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>// TODO</p> <h2 id="gateway网关"><a href="#gateway网关" class="header-anchor">#</a> Gateway网关</h2> <p>Spring Cloud Gateway 是 Spring Cloud 的一个全新项目，该项目是基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等响应式编程和事件流技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</p> <p>Gateway 网关是我们服务的守门神，<strong>所有微服务的统一入口。</strong></p> <p>网关的<strong>核心功能特性</strong>：</p> <ul><li>请求路由</li> <li>权限控制</li> <li>限流</li></ul> <p><img src="https://cdn.xn2001.com/img/2021/20210901092857.png!/format/webp" alt="img"></p> <ul><li><strong>权限控制</strong>：网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。</li> <li><strong>路由和负载均衡</strong>：一切请求都必须先经过 gateway，但网关不处理业务，而是根据某种规则，把请求转发到某个微服务，这个过程叫做路由。当然路由的目标服务有多个时，还需要做负载均衡。</li> <li><strong>限流</strong>：当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大。</li></ul> <p>在 SpringCloud 中网关的实现包括两种：</p> <ul><li>gateway</li> <li>zuul</li></ul> <p>Zuul 是基于 Servlet 实现，属于阻塞式编程。而 Spring Cloud Gateway 则是基于 Spring5 中提供的WebFlux，属于响应式编程的实现，具备更好的性能。</p> <h3 id="入门使用"><a href="#入门使用" class="header-anchor">#</a> 入门使用</h3> <ol><li>创建 SpringBoot 工程 gateway，引入网关依赖</li> <li>编写启动类</li> <li>编写基础配置和路由规则</li> <li>启动网关服务进行测试</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--网关--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--nacos服务发现依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>application.yml 文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/user/开头就符合要求</span>
</code></pre></div><p>我们将符合<code>Path</code> 规则的一切请求，都代理到 <code>uri</code>参数指定的地址。</p> <p>上面的例子中，我们将 <code>/user/**</code> 开头的请求，代理到 <code>lb://userservice</code>，其中 lb 是负载均衡(LoadBalance)，根据服务名拉取服务列表，实现负载均衡。</p> <p>重启网关，访问 <a href="http://localhost:10010/user/1" target="_blank" rel="noopener noreferrer">http://localhost:10010/user/1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 时，符合 <code>/user/**</code> 规则，请求转发到 uri：http://userservice/user/1</p> <p><img src="https://cdn.xn2001.com/img/2021/202108220127419.png!/format/webp" alt="img"></p> <p>路由配置包括：</p> <ol><li>路由id：路由的唯一标示</li> <li>路由目标（uri）：路由的目标地址，http代表固定地址，lb代表根据服务名负载均衡</li> <li>路由断言（predicates）：判断路由的规则</li> <li>路由过滤器（filters）：对请求或响应做处理</li></ol> <blockquote><p>多个 predicates 的话，要同时满足规则</p></blockquote> <p>// TODO</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/huoranger/edit/master/docs/01.后端技术/02.后端技术/06.SpringCloud.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=SpringCloud" title="标签">#SpringCloud</a><a href="/tags/?tag=%E5%BE%AE%E6%9C%8D%E5%8A%A1" title="标签">#微服务</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/11/23, 01:34:55</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev"><a href="/pages/28a0e7/" class="prev">上一篇:SpringSecurity</a></span> <span class="next"><a href="/pages/99a9d9/">下一篇:数据结构与内部编码</a></span></p></div></div></div> <!----></main></div> <div class="footer">
    Copyright © 2019-2022
  </div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-huidaodingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="icon-zidong"><span class="iconfont"></span> <span class="name">跟随系统</span></li><li class="icon-rijianmoshi"><span class="iconfont"></span> <span class="name">浅色模式</span></li><li class="icon-yejianmoshi"><span class="iconfont"></span> <span class="name">深色模式</span></li><li class="icon-yuedu"><span class="iconfont"></span> <span class="name">阅读模式</span></li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.342c2b09.js" defer></script><script src="/assets/js/2.30520199.js" defer></script><script src="/assets/js/3.b6a398a6.js" defer></script><script src="/assets/js/21.aebf0481.js" defer></script>
  </body>
</html>
